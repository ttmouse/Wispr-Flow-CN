# 热键无响应问题排查指南

## 问题现象
- 界面显示绿色状态（热键正常）
- 但按下快捷键没有反应
- 无法触发录音功能

## 常见原因及解决方案

### 1. 系统权限问题（最常见）

#### 检查辅助功能权限
1. 打开 **系统偏好设置** → **安全性与隐私** → **隐私**
2. 在左侧列表中选择 **辅助功能**
3. 确保以下应用已勾选：
   - **Python**（如果通过终端运行）
   - **终端** 或 **iTerm2**（你使用的终端应用）
   - **Dou-flow**（如果已打包为应用）

#### 检查麦克风权限
1. 在同一界面选择 **麦克风**
2. 确保相同的应用已勾选

#### 权限修复步骤
```bash
# 运行权限检查工具
cd /Users/douba/Downloads/GPT插件/ASR-FunASR
python tools/check_permissions.py
```

### 2. 热键冲突检查

#### 系统快捷键冲突
1. 打开 **系统偏好设置** → **键盘** → **快捷键**
2. 检查是否有系统快捷键与应用设置冲突
3. 特别检查：
   - **Ctrl** 键相关快捷键
   - **Fn** 键功能设置
   - **辅助功能** 快捷键

#### 第三方应用冲突
常见冲突应用：
- **Alfred**
- **Raycast**
- **Karabiner-Elements**
- **BetterTouchTool**
- 其他语音输入工具

**解决方法**：
1. 临时关闭这些应用测试
2. 或在这些应用中排除冲突的快捷键

### 3. 应用程序状态检查

#### 重启热键服务
1. 在应用设置中切换热键类型：
   - 从 **Ctrl** 切换到 **Fn**
   - 再切换回 **Ctrl**
2. 观察状态指示器是否变化

#### 完全重启应用
```bash
# 停止当前运行的应用
# 然后重新启动
cd /Users/douba/Downloads/GPT插件/ASR-FunASR
python src/main.py
```

### 4. 系统级别问题

#### macOS 版本兼容性
- **macOS 10.15+**: 需要明确授权辅助功能权限
- **macOS 12+**: 可能需要额外的隐私权限
- **macOS 13+**: 系统安全策略更严格

#### 系统完整性保护 (SIP)
如果问题持续存在，可能需要检查 SIP 设置：
```bash
# 检查 SIP 状态
csrutil status
```

## 详细诊断步骤

### 步骤 1: 权限验证
```bash
# 运行完整权限检查
python tools/check_permissions.py

# 如果权限不足，按提示操作后重新检查
```

### 步骤 2: 热键测试
```bash
# 运行热键测试工具
python tools/check.py
```

### 步骤 3: 日志分析
1. 启动应用时观察控制台输出
2. 按下热键时查看是否有错误信息
3. 检查 `logs/` 目录下的日志文件

### 步骤 4: 状态监控
1. 观察主界面状态指示器
2. 鼠标悬停查看详细状态信息
3. 如果显示红色，按提示信息排查

## 高级排查

### 使用系统监控工具
```bash
# 监控系统事件
sudo log stream --predicate 'process == "Python"' --info

# 监控键盘事件（需要权限）
sudo log stream --predicate 'category == "keyboard"' --debug
```

### 手动测试热键监听
```python
# 创建简单测试脚本
from pynput import keyboard

def on_press(key):
    print(f"按键按下: {key}")

def on_release(key):
    print(f"按键释放: {key}")
    if key == keyboard.Key.esc:
        return False

with keyboard.Listener(on_press=on_press, on_release=on_release) as listener:
    listener.join()
```

## 常见解决方案总结

### 立即尝试的解决方案
1. **重新授权权限**：删除并重新添加辅助功能权限
2. **重启应用**：完全退出后重新启动
3. **切换热键**：尝试不同的热键类型
4. **关闭冲突应用**：临时关闭其他快捷键工具

### 如果问题持续存在
1. **重启系统**：有时需要重启才能生效
2. **重置权限**：在系统偏好设置中重置隐私权限
3. **联系技术支持**：提供详细的错误日志

## 预防措施

1. **定期检查权限**：系统更新后重新确认权限
2. **避免冲突**：安装新的快捷键工具时注意冲突
3. **备份设置**：定期备份应用设置
4. **监控状态**：注意状态指示器的变化

## 技术支持信息

如果以上方法都无法解决问题，请收集以下信息：

1. **系统信息**：macOS 版本
2. **权限状态**：`python tools/check_permissions.py` 输出
3. **应用日志**：控制台输出和日志文件
4. **冲突应用**：已安装的快捷键相关应用列表
5. **错误现象**：详细描述问题发生的情况

通过系统性的排查，大多数热键无响应问题都可以得到解决。